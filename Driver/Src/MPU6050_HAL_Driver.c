//Description: MPU6050 HAL Driver
// [C]2018 - 2023 Nick Computer,

#include "MPU6050_HAL_Driver.h"

uint8_t DATA_2_WRITE=0x00;
uint8_t DATA_2_READ=0x00;

uint8_t HU_MI;

uint8_t INIT_DEBUG = 0x01;

uint8_t at_0x3b = 0;
uint8_t at_0x3c = 0;
uint8_t at_0x3d = 0;
uint8_t at_0x3e = 0;
uint8_t at_0x3f = 0;
uint8_t at_0x40 = 0;

uint8_t at_0x41 = 0;
uint8_t at_0x42 = 0;

uint8_t at_0x43 = 0;
uint8_t at_0x44 = 0;
uint8_t at_0x45 = 0;
uint8_t at_0x46 = 0;
uint8_t at_0x47 = 0;
uint8_t at_0x48 = 0;

int16_t acc_x = 0x00;
int16_t acc_y = 0x00;
int16_t acc_z = 0x00;

int16_t gyr_x = 0x00;
int16_t gyr_y = 0x00;
int16_t gyr_z = 0x00;

int16_t tmp=0x00;

int16_t DATA_SET[7] = {0,0,0,0,0,0,0};

void MPU6050_INIT(I2C_HandleTypeDef* hi2c){
    HAL_I2C_Mem_Read(hi2c,MPU6050_I2C_ADDR,MPU6050_WHO_AM_I,1,&HU_MI,1,MPU6050_I2C_TIMEOUT);

    if(HU_MI == 75){
        DATA_2_WRITE = MPU6050_PWR_MGMT_1_DEF;
        HAL_I2C_Mem_Write(hi2c,MPU6050_I2C_ADDR,MPU6050_PWR_MGMT_1,I2C_MEMADD_SIZE_8BIT,&DATA_2_WRITE,1,MPU6050_I2C_TIMEOUT);
        
        DATA_2_WRITE = MPU6050_SAMPLE_RATE_DIV_DEF;
        HAL_I2C_Mem_Write(hi2c,MPU6050_I2C_ADDR,MPU6050_SAMPLE_RATE_DIV,I2C_MEMADD_SIZE_8BIT,&DATA_2_WRITE,1,MPU6050_I2C_TIMEOUT);
        
        DATA_2_WRITE = MPU6050_CONFIG_DEF;
        HAL_I2C_Mem_Write(hi2c,MPU6050_I2C_ADDR,MPU6050_CONFIG,I2C_MEMADD_SIZE_8BIT,&DATA_2_WRITE,1,MPU6050_I2C_TIMEOUT);
        
        DATA_2_WRITE = MPU6050_GYRO_CONFIG_DEF;
        HAL_I2C_Mem_Write(hi2c,MPU6050_I2C_ADDR,MPU6050_GYRO_CONFIG,I2C_MEMADD_SIZE_8BIT,&DATA_2_WRITE,1,MPU6050_I2C_TIMEOUT);
        
        DATA_2_WRITE = MPU6050_ACCEL_CONFIG_DEF;
        HAL_I2C_Mem_Write(hi2c,MPU6050_I2C_ADDR,MPU6050_ACCEL_CONFIG,I2C_MEMADD_SIZE_8BIT,&DATA_2_WRITE,1,MPU6050_I2C_TIMEOUT);
        
        INIT_DEBUG = 0x00;
    }
}

int16_t MPU6050_UPDATE(I2C_HandleTypeDef hi2c1){
    HAL_I2C_Mem_Read(&hi2c1,MPU6050_I2C_ADDR,MPU6050_ACCEL_XOUT_H,I2C_MEMADD_SIZE_8BIT,&at_0x3b,1,MPU6050_I2C_TIMEOUT);
    HAL_I2C_Mem_Read(&hi2c1,MPU6050_I2C_ADDR,MPU6050_ACCEL_XOUT_L,I2C_MEMADD_SIZE_8BIT,&at_0x3c,1,MPU6050_I2C_TIMEOUT);
    HAL_I2C_Mem_Read(&hi2c1,MPU6050_I2C_ADDR,MPU6050_ACCEL_YOUT_H,I2C_MEMADD_SIZE_8BIT,&at_0x3d,1,MPU6050_I2C_TIMEOUT);
    HAL_I2C_Mem_Read(&hi2c1,MPU6050_I2C_ADDR,MPU6050_ACCEL_YOUT_L,I2C_MEMADD_SIZE_8BIT,&at_0x3e,1,MPU6050_I2C_TIMEOUT);
    HAL_I2C_Mem_Read(&hi2c1,MPU6050_I2C_ADDR,MPU6050_ACCEL_ZOUT_H,I2C_MEMADD_SIZE_8BIT,&at_0x3f,1,MPU6050_I2C_TIMEOUT);
    HAL_I2C_Mem_Read(&hi2c1,MPU6050_I2C_ADDR,MPU6050_ACCEL_ZOUT_L,I2C_MEMADD_SIZE_8BIT,&at_0x40,1,MPU6050_I2C_TIMEOUT);

    HAL_I2C_Mem_Read(&hi2c1,MPU6050_I2C_ADDR,MPU6050_TEMP_OUT_H,I2C_MEMADD_SIZE_8BIT,&at_0x41,1,MPU6050_I2C_TIMEOUT);
    HAL_I2C_Mem_Read(&hi2c1,MPU6050_I2C_ADDR,MPU6050_TEMP_OUT_L,I2C_MEMADD_SIZE_8BIT,&at_0x42,1,MPU6050_I2C_TIMEOUT);

    HAL_I2C_Mem_Read(&hi2c1,MPU6050_I2C_ADDR,MPU6050_GYRO_XOUT_H,I2C_MEMADD_SIZE_8BIT,&at_0x43,1,MPU6050_I2C_TIMEOUT);
    HAL_I2C_Mem_Read(&hi2c1,MPU6050_I2C_ADDR,MPU6050_GYRO_XOUT_L,I2C_MEMADD_SIZE_8BIT,&at_0x44,1,MPU6050_I2C_TIMEOUT);
    HAL_I2C_Mem_Read(&hi2c1,MPU6050_I2C_ADDR,MPU6050_GYRO_YOUT_H,I2C_MEMADD_SIZE_8BIT,&at_0x45,1,MPU6050_I2C_TIMEOUT);
    HAL_I2C_Mem_Read(&hi2c1,MPU6050_I2C_ADDR,MPU6050_GYRO_YOUT_L,I2C_MEMADD_SIZE_8BIT,&at_0x46,1,MPU6050_I2C_TIMEOUT);
    HAL_I2C_Mem_Read(&hi2c1,MPU6050_I2C_ADDR,MPU6050_GYRO_ZOUT_H,I2C_MEMADD_SIZE_8BIT,&at_0x47,1,MPU6050_I2C_TIMEOUT);
    HAL_I2C_Mem_Read(&hi2c1,MPU6050_I2C_ADDR,MPU6050_GYRO_ZOUT_L,I2C_MEMADD_SIZE_8BIT,&at_0x48,1,MPU6050_I2C_TIMEOUT);

    acc_x = (at_0x3b << 8) | at_0x3c;
    acc_y = (at_0x3d << 8) | at_0x3e;
    acc_z = (at_0x3f << 8) | at_0x40;

    tmp = (at_0x41 << 8) | at_0x42;

    gyr_x = (at_0x43 << 8) | at_0x44;
    gyr_y = (at_0x45 << 8) | at_0x46;
    gyr_z = (at_0x47 << 8) | at_0x48;

    DATA_SET[0] = acc_x;
    DATA_SET[1] = acc_y;
    DATA_SET[2] = acc_z;

    DATA_SET[3] = gyr_x;
    DATA_SET[4] = gyr_y;
    DATA_SET[5] = gyr_z;

    DATA_SET[6] = tmp;

}

int16_t* MPU_6050_GET_DATA(void){
    return DATA_SET;
};